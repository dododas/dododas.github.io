<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This post explains the complex-step derivative approximation - a formidable-sounding but simple and elegant numerical method to compute the first derivative of a function using complex arithmetic.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Complex-step derivative approximation" />
<meta property="og:description" content="This post explains the complex-step derivative approximation - a formidable-sounding but simple and elegant numerical method to compute the first derivative of a function using complex arithmetic." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dododas.github.io/posts/2021/2021-03-28-complex-step-derivative/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-29T00:02:51-04:00" />
<meta property="article:modified_time" content="2021-03-29T00:02:51-04:00" />
<title>Complex-step derivative approximation | Raibatak Das</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.78166b9d46e23e0ea915cb6887a30b633e7bc4fad10c8b6b9f6fa532271c19ba.js" integrity="sha256-eBZrnUbiPg6pFctoh6MLYz57xPrRDItrn2&#43;lMiccGbo=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

  <script>
  document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
              delimiters: [
                  {left: "$$", right: "$$", display: true},
                  {left: "$", right: "$", display: false},
              ]
          }
          );
    });
  </script>




<link rel="stylesheet" href="/css/custom.css">


</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Raibatak Das</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  <ul>
<li><a href="/posts"><strong>Posts</strong></a></li>
<li><a href="/"><strong>About</strong></a></li>
</ul>










</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Complex-step derivative approximation</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#does-it-work">Does it work?</a></li>
        <li><a href="#does-it-really-work">Does it <em>really</em> work?</a>
          <ul>
            <li><a href="#code--explanation">Code &amp; explanation</a></li>
          </ul>
        </li>
        <li><a href="#how-good-is-it">How good is it?</a></li>
        <li><a href="#notes-and-references">Notes and References</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown">
  <h1>
    <a href="/posts/2021/2021-03-28-complex-step-derivative/">Complex-step derivative approximation</a>
  </h1>
  
  <h5>March 29, 2021</h5>



  

  
  <div>
    
      <a href="/tags/python/">python</a>, 
      <a href="/tags/complex-numbers/">complex numbers</a>
  </div>
  



<p>This post explains the complex-step derivative approximation - a formidable-sounding but simple and elegant numerical method to compute the first derivative of a function using complex arithmetic.</p>
<h2 id="introduction">
  Introduction
  <a class="anchor" href="#introduction">#</a>
</h2>
<p>The complex step derivative approximation is a technique to compute the derivative of a real-valued function $f(x)$. The derivation is a simple two line affair. Expand $f(x)$ in Taylor series using a small imaginary step $i h$ and keep the leading order term in $h$:
$$ \begin{aligned}
f(x + ih) &amp; = f(x) + ih \cdot f&rsquo;(x) - \frac{h^2}{2!} f&rsquo;&rsquo;(x) + \ldots \cr
\Re[f(x + ih)] + i \Im[f(x + ih)]  &amp; \approx f(x) + i h \cdot f&rsquo;(x)
\end{aligned} $$</p>
<p>Comparing imaginary parts of the two sides gives:
$$\boxed{f&rsquo;(x) \approx \frac{\Im[f(x + ih)]}{h}} $$</p>
<p>where $h$ is a small step, eg: $10^{-8}$. And that&rsquo;s it!</p>
<h2 id="does-it-work">
  Does it work?
  <a class="anchor" href="#does-it-work">#</a>
</h2>
<p>These examples test the formula on some simple functions with known first derivatives</p>
<p><strong>Example 1</strong>: $f(x) = x^2$. Expand the right hand side and drop the second order term:
$$ \begin{aligned}
f(x + ih) &amp; = (x + ih) \cdot (x + ih) \cr
&amp; = x^2 + i \cdot(2xh) - \cancel{h^2}
\end{aligned} $$</p>
<p>Comparing imaginary parts:
$$ f&rsquo;(x) = \frac{1}{h} \Im[(f(x + ih)] = 2x $$</p>
<p>which is correct.</p>
<p><strong>Example 2</strong>: $f(x) = \sin(x)$. Expand the right hand side using a trigonometric identity, and use the small number approximations $\sin(\theta) \approx \theta$ and $\cos(\theta) \approx 1$ when $\theta \approx 0$:
$$ \begin{aligned}
f(x + ih) &amp; = \sin(x + ih) \cr
&amp; = \sin(x) \cos(ih) + \cos(x)  \sin(i h) \cr
&amp; \simeq \sin(x) + ih \cos(x)
\end{aligned} $$</p>
<p>This gives
$$ f&rsquo;(x) = \frac{1}{h} \Im[f(x + ih)] = \cos(x) $$</p>
<p>which is correct.</p>
<p><strong>Example 3</strong>: $f(x) = e^x$. Expand the right hand side using Euler&rsquo;s formuela.
$$ \begin{aligned}
f(x + ih) &amp; = e^{x + ih} \cr
&amp; = e^x \cdot e^{ih} \cr
&amp; = e^x \left[ \cos(h) + i \sin(h) \right] \cr
&amp; \simeq e^x + i h e^x
\end{aligned} $$</p>
<p>Compare imaginary parts:
$$ f&rsquo;(x) = \frac{1}{h} \Im[f(x + ih)] = e^x $$</p>
<p>Right again!</p>
<h2 id="does-it-really-work">
  Does it <em>really</em> work?
  <a class="anchor" href="#does-it-really-work">#</a>
</h2>
<p>The next example implements this method in Python to numerically compute the derivative of
$$ f(x) = \frac{e^x}{(\cos x)^3 + (\sin x)^3} $$</p>
<p>This function is a standard example used to demonstrate the complex step derivative. The plot below shows the function (green curve) and its derivative computed using the complex step approximation (orange curve) overlaid with the <em>exact</em> analytic solution (dashed curve). Visually, the approximation is indistinguishable from the exact solution. A more rigorous error analysis is described in the next section</p>
<p><img src="complex-step-derivative-ex1.png" alt="Complex step derivative" /></p>
<h3 id="code--explanation">
  Code &amp; explanation
  <a class="anchor" href="#code--explanation">#</a>
</h3>
<p>To generate this plot first define a function that implements the complex step derivative for any input function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">csderiv</span>(func, h <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-8</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Complex-step derivative approximation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>( <span style="color:#66d9ef">lambda</span> x: np<span style="color:#f92672">.</span>imag(func(np<span style="color:#f92672">.</span>complex(x, h)))<span style="color:#f92672">/</span>h )
</span></span></code></pre></div><p>Then define the specific function above and its complex step derivative</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>f <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x: np<span style="color:#f92672">.</span>exp(x) <span style="color:#f92672">/</span> ((np<span style="color:#f92672">.</span>cos(x))<span style="color:#f92672">**</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> (np<span style="color:#f92672">.</span>sin(x))<span style="color:#f92672">**</span><span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>dfdx <span style="color:#f92672">=</span> csderiv(f)
</span></span></code></pre></div><p>For comparison, define the exact analytical derivative
$$ f&rsquo;(x) = f(x) \cdot \frac{(\cos x)^3 + (\sin x)^3 + 3 \cos x \sin x \left(\cos x - \sin x \right)}{(\cos x)^3 + (\sin x)^3}
$$</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fprime</span>(x): 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Analytic derivative of e^x / ((cos x)^3 + (sin x)^3)</span>
</span></span><span style="display:flex;"><span>    den <span style="color:#f92672">=</span> (np<span style="color:#f92672">.</span>cos(x))<span style="color:#f92672">**</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> (np<span style="color:#f92672">.</span>sin(x))<span style="color:#f92672">**</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    num <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>exp(x) <span style="color:#f92672">*</span> (den <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>cos(x)<span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>sin(x)<span style="color:#f92672">*</span>(np<span style="color:#f92672">.</span>cos(x) <span style="color:#f92672">-</span> np<span style="color:#f92672">.</span>sin(x)))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>( num<span style="color:#f92672">/</span>(den<span style="color:#f92672">*</span>den) )
</span></span></code></pre></div><p>To generate data for the plot, compute the function its derivative using both methods over a range</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span><span style="color:#ae81ff">3.9</span><span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>, np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>y, dy, exact <span style="color:#f92672">=</span> [np<span style="color:#f92672">.</span>array([y(xval) <span style="color:#66d9ef">for</span> xval <span style="color:#f92672">in</span> x]) <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> (f, dfdx, fprime)]
</span></span></code></pre></div><p>Finally, plot results</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Plot function and derivative</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib <span style="color:#66d9ef">as</span> mpl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>plot(x, y, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$f(x)$&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>plot(x, dy, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.5</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$f&#39;(x)$: complex step&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>plot(x, exact, <span style="color:#e6db74">&#34;k--&#34;</span>, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$f&#39;(x)$: exact&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_ylim([<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">5</span>])
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xticks([<span style="color:#f92672">-</span>np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>, np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xticklabels((<span style="color:#e6db74">&#34;-$\pi$/4&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;$\pi$/4&#34;</span>, <span style="color:#e6db74">&#34;$\pi$/2&#34;</span>))
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>grid(<span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="how-good-is-it">
  How good is it?
  <a class="anchor" href="#how-good-is-it">#</a>
</h2>
<p>To evaluate the accuracy of this approximation we can compute the absolute error between the complex step derivative and the exact solution. For comparison the derivative is also calculated using the finite difference approximation:
$$f&rsquo;_{\text{fd}}(x) \simeq \frac{f(x + h/2) - f(x - h/2)}{h} $$</p>
<p>Results are shown below:
<img src="complex-step-v-finite-diff-1.png" alt="Error plot" /></p>
<p>The complex step approximation is more accurate than the finite difference estimate by several orders of magnitude. The next set of plots examines the effect of changing the step size $h$ on the accuracy of the two methods.
<img src="complex-step-v-finite-diff-2.png" alt="Error vs h" /></p>
<p>The complex step derivative approximation continues to be accurate with smaller step sizes whereas the finite difference estimate gets worse. This seemingly non-intuitive behavior of the finite difference approximation is the result of truncation error from the subtraction of two numbers that are close to each other. As $h$ gets smaller the two terms in the numerator get closer to each other and leading digits in the difference $f(x + h/2) - f(x - h/2)$ become 0. The complex step approximation is not subject to this truncation error.</p>
<p>The following code computes the finite difference approximation and plots the absolute error for each estimate.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fdiff</span>(func, h <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-8</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Finite difference derivative approximation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>( <span style="color:#66d9ef">lambda</span> x: (f(x<span style="color:#f92672">+</span>h<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> f(x<span style="color:#f92672">-</span>h<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">/</span>h )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compute finite difference </span>
</span></span><span style="display:flex;"><span>dfdx_fd <span style="color:#f92672">=</span> fdiff(f)
</span></span><span style="display:flex;"><span>dy_fd <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([dfdx_fd(xval) <span style="color:#66d9ef">for</span> xval <span style="color:#f92672">in</span> x])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Plot absolute error</span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>plot(x, np<span style="color:#f92672">.</span>abs(dy_fd <span style="color:#f92672">-</span> exact), <span style="color:#e6db74">&#34;C2&#34;</span>, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>,
</span></span><span style="display:flex;"><span>        label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Finite difference&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>plot(x, np<span style="color:#f92672">.</span>abs(dy <span style="color:#f92672">-</span> exact), <span style="color:#e6db74">&#34;C1&#34;</span>, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>, 
</span></span><span style="display:flex;"><span>        label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Complex step&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_yscale(<span style="color:#e6db74">&#34;log&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Absolute error&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xticks([<span style="color:#f92672">-</span>np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>, np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xticklabels((<span style="color:#e6db74">&#34;-$\pi$/4&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;$\pi$/4&#34;</span>, <span style="color:#e6db74">&#34;$\pi$/2&#34;</span>))
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;Complex step -vs- finite difference (h = $10^{-8}$)&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;x&#34;</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>grid(<span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>The next block computes the derivative using both methods with different step sizes to generate the final panel of plots.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Compute both approximations for different step sizes</span>
</span></span><span style="display:flex;"><span>steps <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1e-6</span>, <span style="color:#ae81ff">1e-8</span>, <span style="color:#ae81ff">1e-12</span>, <span style="color:#ae81ff">1e-16</span>]
</span></span><span style="display:flex;"><span>csout <span style="color:#f92672">=</span> {h: np<span style="color:#f92672">.</span>array([csderiv(f, h)(xvals) <span style="color:#66d9ef">for</span> xvals <span style="color:#f92672">in</span> x]) 
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> steps}
</span></span><span style="display:flex;"><span>fdout <span style="color:#f92672">=</span> {h: np<span style="color:#f92672">.</span>array([fdiff(f, h)(xvals) <span style="color:#66d9ef">for</span> xvals <span style="color:#f92672">in</span> x]) 
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> steps}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Plot absolute errors for each step size</span>
</span></span><span style="display:flex;"><span>fig, splots <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(ncols <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, sharey <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;row&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> jj, h <span style="color:#f92672">in</span> enumerate(steps):
</span></span><span style="display:flex;"><span>    y1, y2 <span style="color:#f92672">=</span> csout[h], fdout[h]
</span></span><span style="display:flex;"><span>    ax <span style="color:#f92672">=</span> splots[jj]
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>plot(x, abs(y2 <span style="color:#f92672">-</span> exact), <span style="color:#e6db74">&#34;C2&#34;</span>, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>,
</span></span><span style="display:flex;"><span>            label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Finite difference&#34;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>plot(x, abs(y1 <span style="color:#f92672">-</span> exact), <span style="color:#e6db74">&#34;C1&#34;</span>, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>,
</span></span><span style="display:flex;"><span>            label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Complex step&#34;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_yscale(<span style="color:#e6db74">&#34;log&#34;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_xticks([<span style="color:#f92672">-</span>np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>, np<span style="color:#f92672">.</span>pi<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_xticklabels((<span style="color:#e6db74">&#34;-$\pi$/4&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;$\pi$/4&#34;</span>, <span style="color:#e6db74">&#34;$\pi$/2&#34;</span>))
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;x&#34;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;h = </span><span style="color:#e6db74">{</span>h<span style="color:#e6db74">:</span><span style="color:#e6db74">.0e</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>grid()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> jj <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Absolute error&#34;</span>)
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>legend(loc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;upper right&#34;</span>, 
</span></span><span style="display:flex;"><span>                  bbox_to_anchor <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1.02</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>suptitle(<span style="color:#e6db74">&#34;Complex step -vs- finite difference with varying step size&#34;</span>)
</span></span></code></pre></div><h2 id="notes-and-references">
  Notes and References
  <a class="anchor" href="#notes-and-references">#</a>
</h2>
<p>The complex step derivative approximation was first described by Squire &amp; Trapp (1998) based on results originally presented by Lyness &amp; Moler (1967). Complete code for this example is available in <a href="https://github.com/dododas/dododas.github.io/blob/main/content/posts//2021-03-28-complex-step-derivative/complex-step-derivative.ipynb">this Jupyter notebook</a></p>
<p><strong>References</strong></p>
<ol>
<li>&ldquo;Using Complex Variables to Estimate Derivatives of Real Functions&rdquo; by Squire and Trapp, <em>SIAM Rev.</em>, 40(1), 110â€“112 <a href="https://epubs.siam.org/doi/abs/10.1137/S003614459631241X">https://epubs.siam.org/doi/abs/10.1137/S003614459631241X</a></li>
<li>&ldquo;Numerical differentiation of analytic functions&rdquo; by Lyness and Moler, <em>SIAM J Numer Anal</em>, 4(2), 202-210 <a href="https://epubs.siam.org/doi/abs/10.1137/0704019">https://epubs.siam.org/doi/abs/10.1137/0704019</a></li>
<li><a href="https://blogs.mathworks.com/cleve/2013/10/14/complex-step-differentiation">https://blogs.mathworks.com/cleve/2013/10/14/complex-step-differentiation</a></li>
<li><a href="complex-step-derivative.ipynb">Download Jupyter notebook with code</a></li>
</ol></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#does-it-work">Does it work?</a></li>
        <li><a href="#does-it-really-work">Does it <em>really</em> work?</a>
          <ul>
            <li><a href="#code--explanation">Code &amp; explanation</a></li>
          </ul>
        </li>
        <li><a href="#how-good-is-it">How good is it?</a></li>
        <li><a href="#notes-and-references">Notes and References</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












